name: Nightly Integration Tests

on:
  # Ğ—Ğ°Ğ¿ÑƒÑĞº ĞºĞ°Ğ¶Ğ´ÑƒÑ Ğ½Ğ¾Ñ‡ÑŒ Ğ² 02:00 UTC
  schedule:
    - cron: '0 2 * * *'
  # Ğ¢Ğ°ĞºĞ¶Ğµ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ
  workflow_dispatch:
    inputs:
      test_scope:
        description: 'Test scope'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - notion-only
          - connection-only

env:
  GO_VERSION: '1.22.x'

jobs:
  nightly-integration:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Build applications
        run: |
          echo "ğŸ”¨ Building applications..."
          go build -o ai-chatter cmd/bot/main.go
          go build -o notion-mcp-server cmd/notion-mcp-server/main.go
          go build -o test-custom-mcp cmd/test-custom-mcp/main.go

      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      - name: Check environment setup
        run: |
          echo "ğŸ” Checking CI environment..."
          echo "Go version: $(go version)"
          echo "OS: $(uname -a)"
          echo "Available memory: $(free -h)"
          echo "Available disk: $(df -h .)"

      - name: Validate secrets
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_TEST_PAGE_ID: ${{ secrets.NOTION_TEST_PAGE_ID }}
        run: |
          if [ -z "$NOTION_TOKEN" ]; then
            echo "âŒ NOTION_TOKEN secret is not configured"
            echo "ğŸ”§ Configure it in GitHub repository settings: Settings â†’ Secrets and variables â†’ Actions"
            exit 1
          fi
          
          if [ -z "$NOTION_TEST_PAGE_ID" ]; then
            echo "âŒ NOTION_TEST_PAGE_ID secret is not configured"
            echo "ğŸ”§ Configure it in GitHub repository settings: Settings â†’ Secrets and variables â†’ Actions"
            exit 1
          fi
          
          echo "âœ… All required secrets are configured"

      - name: Run full integration test suite
        if: ${{ inputs.test_scope == 'full' || inputs.test_scope == '' }}
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_TEST_PAGE_ID: ${{ secrets.NOTION_TEST_PAGE_ID }}
        run: |
          echo "ğŸš€ Running full integration test suite..."
          ./scripts/test-notion-integration.sh

      - name: Run Notion-only tests
        if: ${{ inputs.test_scope == 'notion-only' }}
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_TEST_PAGE_ID: ${{ secrets.NOTION_TEST_PAGE_ID }}
        run: |
          echo "ğŸ“ Running Notion-specific tests..."
          go test ./internal/notion -run "TestMCPIntegration" -v -timeout=10m

      - name: Run connection tests
        if: ${{ inputs.test_scope == 'connection-only' }}
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        run: |
          echo "ğŸ”— Running connection tests..."
          go test ./internal/notion -run "TestMCPConnection" -v -timeout=5m

      - name: Performance benchmarks
        if: ${{ inputs.test_scope == 'full' || inputs.test_scope == '' }}
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_TEST_PAGE_ID: ${{ secrets.NOTION_TEST_PAGE_ID }}
        run: |
          echo "âš¡ Running performance benchmarks..."
          
          # Ğ˜Ğ·Ğ¼ĞµÑ€ÑĞµĞ¼ Ğ²Ñ€ĞµĞ¼Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
          echo "ğŸ“„ Testing page creation speed..."
          time go test ./internal/notion -run "TestMCPIntegration/CreateFreeFormPage" -v -count=1
          
          # Ğ˜Ğ·Ğ¼ĞµÑ€ÑĞµĞ¼ Ğ²Ñ€ĞµĞ¼Ñ Ğ¿Ğ¾Ğ¸ÑĞºĞ°
          echo "ğŸ” Testing search speed..."
          time go test ./internal/notion -run "TestMCPIntegration/SearchWorkspace" -v -count=1

      - name: Generate test report
        if: always()
        run: |
          echo "ğŸ“Š Generating test report..."
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚
          cat > test-report.md << 'EOF'
          # ğŸ§ª Nightly Integration Test Report
          
          **Date:** $(date)
          **Commit:** ${{ github.sha }}
          **Workflow:** ${{ github.workflow }}
          **Test Scope:** ${{ inputs.test_scope || 'full' }}
          
          ## Environment
          - **Go Version:** ${{ env.GO_VERSION }}
          - **OS:** ubuntu-latest
          - **Runner:** ${{ runner.name }}
          
          ## Test Results
          EOF
          
          if [ -f test-results.txt ]; then
            cat test-results.txt >> test-report.md
          else
            echo "Test results not available" >> test-report.md
          fi

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-test-results-${{ github.run_number }}
          path: |
            test-report.md
            *.log
            coverage.out
          retention-days: 30

      - name: Notify on failure
        if: failure()
        run: |
          echo "ğŸš¨ Nightly integration tests failed!"
          echo "Check the logs and test results for details."
          echo "This could indicate:"
          echo "  - Notion API changes"
          echo "  - Network connectivity issues"
          echo "  - Test environment problems"
          echo "  - Regression in the codebase"

  # Job Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° Ñ‚Ñ€ĞµĞ½Ğ´Ğ¾Ğ²
  trend-analysis:
    runs-on: ubuntu-latest
    needs: nightly-integration
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ĞÑƒĞ¶Ğ½Ğ° Ğ¿Ğ¾Ğ»Ğ½Ğ°Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°

      - name: Analyze test trends
        run: |
          echo "ğŸ“ˆ Analyzing test trends..."
          
          # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 10 Ğ·Ğ°Ğ¿ÑƒÑĞºĞ¾Ğ² workflow
          echo "## Recent Integration Test Results" > trend-report.md
          echo "" >> trend-report.md
          echo "| Date | Status | Duration | Commit |" >> trend-report.md
          echo "|------|--------|----------|--------|" >> trend-report.md
          
          # Ğ—Ğ´ĞµÑÑŒ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· Ñ‡ĞµÑ€ĞµĞ· GitHub API
          # ĞŸĞ¾ĞºĞ° Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ
          if [ "${{ needs.nightly-integration.result }}" == "success" ]; then
            echo "| $(date) | âœ… Success | - | ${{ github.sha }} |" >> trend-report.md
          else
            echo "| $(date) | âŒ Failed | - | ${{ github.sha }} |" >> trend-report.md
          fi
          
          echo "" >> trend-report.md
          echo "**Legend:** âœ… Success, âŒ Failed, â¸ï¸ Cancelled, âš ï¸ Skipped" >> trend-report.md

      - name: Upload trend analysis
        uses: actions/upload-artifact@v4
        with:
          name: trend-analysis-${{ github.run_number }}
          path: trend-report.md
          retention-days: 90
